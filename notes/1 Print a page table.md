这个还挺简单的，我们的实现如下：

```c
static void walkprint(pagetable_t pagetable, int level)

{

  for (int i = 0; i < PGSIZE / sizeof(pte_t); i++)

  {

    pte_t pte = pagetable[i];

    uint64 pa = PTE2PA(pte);

  

    if (!(pte & PTE_V))

      continue;

  

    for (int j = 0; j < level; j++){

      if(j!=0)

        printf(" ");

      printf("..");

    }

    printf("%d: pte %p pa %p\n", i, pte, pa);

  

    if (level<3 && (pte & PTE_V) && ((pte & (PTE_R | PTE_W | PTE_X)) == 0))

      walkprint((pagetable_t)pa, level + 1);

  }

}

  

void vmprint(pagetable_t pagetable)

{

  printf("page table %p\n", pagetable);

  walkprint(pagetable, 1);

}
```

在这里强调一下各级PTE标志位的含义：

**PTE（Page Table Entry）是一个 64 位的整数**。

- **高 54 位**：存储物理页号（PPN），也就是下一级要去哪儿。
    
- **低 10 位**：标志位（Flags），决定了这一项是干嘛的。
    

我们在代码里看到的 `PTE_V`, `PTE_R` 这些宏，其实就是掩码（Mask），用来把这些特定的位提取出来。

RISC-V 并没有一个专门的位叫“IsLeaf”。它用了一种很聪明的**组合逻辑**来区分中间层和最底层。

我们只看这三个权限位：**`R` (Read), `W` (Write), `X` (Execute)**。

情况 A：中间路标 (Node / Directory PTE)

**特征**：$V=1$ 且 $R=0, W=0, X=0$

**含义**：这里没有数据，指向的是**下一级页表**的地址。

硬件行为MMU（内存管理单元）看到这种组合，会读取高位的 PPN，把它当作下一级页表的物理基址，继续往下查。

这就是为什么 `vmprint` 递归里要写 `(pte & (PTE_R|PTE_W|PTE_X)) == 0`。如果给中间层设置了 `R=1`，硬件就会以为找到数据了，结果读出来的是乱码（把页表当数据读了）。

情况 B：终点数据 (Leaf PTE)

特征：$V=1$ 且 ($R=1$ 或 $W=1$ 或 $X=1$)

含义：指向的是真正的**物理数据页**。

硬件行为：MMU 停止查表，根据权限检查当前操作（读/写/执行）是否合法。如果合法，直接进行地址转换。

这也解释了超级页（Superpage）。如果这个 Leaf PTE 出现在第 2 级（也就是最高级），它就代表一个 1GB 的大页；出现在第 1 级，代表 2MB 的大页；出现在第 0 级，代表普通的 4KB 页。

xv6的标志位如下表：

| **位 (Bit)** | **宏名称** | **全称**       | **教授的详细解读**                                                                                                                                                                                         |
| ----------- | ------- | ------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **0**       | `PTE_V` | **Valid**    | **“存在位”**。<br><br>  <br><br>这是总开关。如果 $V=0$，无论后面是什么，硬件都会直接抛出 **Page Fault**（缺页异常）。<br><br>  <br><br>在 xv6 中，`V=0` 通常意味着这页内存没被分配，或者被换出去了。                                                             |
| **1**       | `PTE_R` | Read         | **“可读”**。<br><br>  <br><br>允许读取该页内容。                                                                                                                                                                |
| **2**       | `PTE_W` | Write        | **“可写”**。<br><br>  <br><br>允许修改该页内容。                                                                                                                                                                |
| **3**       | `PTE_X` | Execute      | **“可执行”**。<br><br>  <br><br>允许 CPU 将该页内容当作指令执行。<br><br>  <br><br>_安全提示_：通常数据段（Stack/Heap）是 `RW-`，代码段（Text）是 `R-X`。防止有人在堆栈上写恶意代码并执行。                                                                 |
| **4**       | `PTE_U` | **User**     | **“用户位”**。<br><br>  <br><br>$U=1$：**用户模式（User Mode）** 可以访问。这也是为什么内核映射自己的内存时必须设 $U=0$，防止用户程序偷窥内核。<br><br>  <br><br>$U=0$：只有**内核模式（Supervisor Mode）** 可以访问。                                           |
| **5**       | `PTE_G` | Global       | **“全局位”**。<br><br>  <br><br>在 xv6 中我们通常不怎么用它。它的作用是告诉 TLB（页表缓存）：“这一项是全局通用的，切换进程（切换 `satp`）时不要清空我。” 通常用于内核共享区域。                                                                                       |
| **6**       | `PTE_A` | **Accessed** | **“访问位”**（重点！）。<br><br>  <br><br>**谁设置？** 硬件。当该页被读或写时，硬件自动将其置 1。<br><br>  <br><br>**谁清除？** 软件（操作系统）。<br><br>  <br><br>**用途**：这正是你下一个实验 `pgaccess` 要用的！通过定期检查并清除这位，OS 可以知道哪些页面最近很“热”，哪些很“冷”（LRU 算法）。 |
| **7**       | `PTE_D` | **Dirty**    | **“脏位”**。<br><br>  <br><br>**谁设置？** 硬件。只有当该页被**写入**时，硬件才置 1。<br><br>  <br><br>**用途**：决定页面置换时是否需要写回磁盘。如果 $D=0$，说明没改过，直接丢弃即可；如果 $D=1$，必须写回文件系统。                                                       |
| **8-9**     | RSW     | Reserved     | **“保留位”**。<br><br>  <br><br>给操作系统自己玩的，硬件完全忽略。你可以用它来存一些自定义的状态（但在 Lab 里一般用不到）。                                                                                                                        |